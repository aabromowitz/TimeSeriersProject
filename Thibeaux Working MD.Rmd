---
title: "Thibeaux Working MD"
author: "Thibeaux"
date: "2024-11-22"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Libraries

```{r, message=FALSE, "Load Libraries"}
library(tidyverse)
library(tswge)
library(vars)
library(lubridate)
library(nnfor)
```
# Load Data
```{r Load and wrangle data}

# Variable of Interest - Quarterly from 1/1/63
file_path = "https://raw.githubusercontent.com/aabromowitz/TimeSeriersProject/refs/heads/main/MSPUS.csv"
mhp <- read.csv(file_path, header = TRUE)

# Home ownership rate - Quarterly from 1/1/65
file_path = "https://raw.githubusercontent.com/aabromowitz/TimeSeriersProject/refs/heads/main/RHORUSQ156N.csv"
hor <- read.csv(file_path, header = TRUE)

# Housing units completed - Monthly from 1/1/1968
file_path = "https://raw.githubusercontent.com/aabromowitz/TimeSeriersProject/refs/heads/main/COMPUTSA.csv"
huc <- read.csv(file_path, header = TRUE)

# Supply of new houses - Monthly from 1/1/1963
file_path = "https://raw.githubusercontent.com/aabromowitz/TimeSeriersProject/refs/heads/main/MSACSR.csv"
snh <- read.csv(file_path, header = TRUE)

# House price index - Quarterly from 1/1/1975
file_path = "https://raw.githubusercontent.com/aabromowitz/TimeSeriersProject/refs/heads/main/USSTHPI.csv"
hpi <- read.csv(file_path, header = TRUE)

# Converting Monthly Data to Quarterly Data

# Preserve Monthly format
snh_monthly <- snh
huc_monthly <- huc

# Supply of New Houses Variable 
snh$DATE = as.Date(snh$DATE)
snh$month <- month(snh$DATE)
head(snh)
snh_quarterly <- snh %>%
  filter(snh$month == 1 | snh$month == 4 | snh$month == 7 | snh$month == 10)
summary(snh_quarterly)

# Housing Units Completed Variable
huc$DATE = as.Date(huc$DATE)
huc$month <- month(huc$DATE)
head(huc)
huc_quarterly <- huc %>%
  filter(huc$month == 1 | huc$month == 4 | huc$month == 7 | huc$month == 10)
summary(huc_quarterly)

# Using same time frames, which would be starting at 1975 Q1 and ending at 2024 Q2 (due to hpi data)

# hor observation 41 is 1975 Q1
hor_1975 = hor[41:238,]
hor_1975$DATE <- as.Date(hor_1975$DATE)
summary(hor_1975)

# huc_quarterlly observation 29
huc_1975 = huc_quarterly[29:226,]
summary(huc_1975)

# mhp observation 49 is 1975 Q1
mhp_1975 = mhp[49:246,]
mhp_1975$DATE <- as.Date(mhp_1975$DATE)
summary(mhp_1975)

# snh_quarterly observation 49 is 1975 Q1
snh_1975 = snh_quarterly[49:246,]
summary(snh_1975)

# Housing Price Index variable already from 1975 Q1 - 2024 Q2
hpi$DATE <- as.Date(hpi$DATE)
summary(hpi)

# Create Dataframe
# Combined (Train/Test) Set NOT LOGGED
fed_housing_data_NL = data.frame(Year_Quarter = mhp_1975$DATE, Ownership_Rate = hor_1975$RHORUSQ156N, Housing_Units_Completed = huc_1975$COMPUTSA, Supply_New_Houses = snh_1975$MSACSR, Housing_Price_Index = hpi$USSTHPI, Median_Sales_Price = mhp_1975$MSPUS)

# Combined (Train/Test) Set LOGGED
fed_housing_data = data.frame(Year_Quarter = as.Date(mhp_1975$DATE), Ownership_Rate = hor_1975$RHORUSQ156N, Housing_Units_Completed = huc_1975$COMPUTSA, Supply_New_Houses = snh_1975$MSACSR, Housing_Price_Index = hpi$USSTHPI, Median_Sales_Price = log(mhp_1975$MSPUS))

# Train & Test sets
train = fed_housing_data[1:168,]
test = fed_housing_data[169:198,]

summary(fed_housing_data)
```

# Signal Plus Noise Model
### Test for linear Trend
```{r Test for linear trend}
# Testing for Linear Trend
t = 1:168
reg = slr.wge(train$Median_Sales_Price)

# Cochran Orcutt Test for Linear Trend
co_test_msp = co.wge(train$Median_Sales_Price)
co_test_msp$pvalue

# WBG Test
wbg.boot.wge(train$Median_Sales_Price)

# Linear model according to Simple Linear Regression (ignoring correlated errors)
plotts.wge(train$Median_Sales_Price)
fit = reg$b0hat + t*reg$b1hat
points(fit, type = "l")

# Examine Residuals
resid = train$Median_Sales_Price - fit
plot(resid, type = "l")
abline(h=0)
# Residuals look different than the residuals for the combined (train/test) set.

# Quicker way to plot residuals: plot(reg$res, type = "l")
```

Null hypothesis rejected in all tests (Note: Barely rejects hypothesis with WBG test)

### Models
```{r Signal Plus Noise models}
# Fit signal plus noise models

# MLE Estimates with AIC
spn.mle.aic = aic.ar.wge(reg$res, type = 'aic', p = 0:7)
spn.mle.aic # ar(6), aic -7.269686

# MLE Estimates with AICC
spn.mle.aicc = aic.ar.wge(reg$res, type = 'aicc', p = 0:7)
spn.mle.aicc # ar(6), aicc -6.25239

# MLE Estimates with BIC
spn.mle.bic = aic.ar.wge(reg$res, type = 'bic', p = 0:7)
spn.mle.bic # ar(2), bic -7.147245

# Burg Estimates with AIC
spn.b.aic = aic.burg.wge(reg$res, p = 1:7, type = 'aic')
spn.b.aic # ar(6), aic -7.278742

# Burg Estimates with AICC
spn.b.aicc = aic.burg.wge(reg$res, p = 1:7, type = 'aicc')
spn.b.aicc # ar(6), aicc -6.261446

# Burg Estimates with BIC
spn.b.bic = aic.burg.wge(reg$res, p = 1:7, type = 'bic')
spn.b.bic # ar(6), bic -7.157681

# Create table for comparison
labels = c("aic", "aicc", "bic")
mle.ests = c(spn.mle.aic$value, spn.mle.aicc$value, spn.mle.bic$value)
burg.ests = c(spn.b.aic$value, spn.b.aicc$value, spn.b.bic$value)
comparison = data.frame(labels,mle.ests,burg.ests)
comparison

# MLE estimates are better for all types: aic, aicc, bic

# Fit with MLE estimates, train/test set
fit.mle.sig = fore.sigplusnoise.wge(train$Median_Sales_Price, linear = TRUE, method = 'mle', freq = 0, max.p = 6, n.ahead = 30)
fit.mle.sig$b0hat
fit.mle.sig$b1hat

# Different Plot
log.mhp = fed_housing_data$Median_Sales_Price
plot(log.mhp, type = 'l')
lines(seq(169,198,1), fit.mle.sig$f, col = "blue")

# Examine residuals
plot(fit.mle.sig$resid)

# ASE with MLE estimates
ASE = mean((test$Median_Sales_Price - fit.mle.sig$f)^2)
ASEexp = mean((exp(test$Median_Sales_Price) - exp(fit.mle.sig$f))^2)
ASEexp # 826.5M

# Fit with burg estimates, train/test set
fit.b.sig = fore.sigplusnoise.wge(train$Median_Sales_Price, linear = TRUE, method = 'burg', freq = 0, max.p = 6, n.ahead = 30)
fit.b.sig$b0hat
fit.b.sig$b1hat

# Different Plot
plot(log.mhp, type = 'l')
lines(seq(169,198,1), fit.b.sig$f, col = "blue")

# Examine residuals
plot(fit.b.sig$resid)

# ASE with Burg estimates
ASE.b = mean((test$Median_Sales_Price - fit.b.sig$f)^2)
ASE.b.exp = mean((exp(test$Median_Sales_Price) - exp(fit.b.sig$f))^2)
ASE.b.exp # 1.11B

# MLE estimates are better than Burg estimates, as expected
ASEexp < ASE.b.exp
```
### Signal Plus Noise using all data
```{r Signal Plus Noise without holding data out}
# Making sure log.mhp is the correct data
log.mhp = fed_housing_data$Median_Sales_Price

# Fit with MLE estimates, using all data
fit.mle.sig_notTT = fore.sigplusnoise.wge(log.mhp, linear = TRUE, method = 'mle', freq = 0, max.p = 6, n.ahead = 30, lastn = TRUE)
fit.mle.sig_notTT$b0hat
fit.mle.sig_notTT$b1hat
fit.mle.sig_notTT$phi.z

# Different Plot
plot(log.mhp, type = 'l')
lines(seq(169,198,1), fit.mle.sig_notTT$f, col = "blue")

# Examine residuals
plot(fit.mle.sig$resid)

# ASE with MLE estimates
ASE.full = mean((log.mhp[169:198] - fit.mle.sig_notTT$f)^2)
ASEexp.full = mean((exp(log.mhp[169:198]) - exp(fit.mle.sig_notTT$f))^2)
ASEexp.full # 595M

# Fit with burg estimates, using all data
fit.b.sig_notTT = fore.sigplusnoise.wge(log.mhp, linear = TRUE, method = 'burg', freq = 0, max.p = 6, n.ahead = 30, lastn = TRUE)
fit.b.sig_notTT$b0hat
fit.b.sig_notTT$b1hat
fit.b.sig_notTT$phi.z

# Different Plot
plot(log.mhp, type = 'l')
lines(seq(169,198,1), fit.b.sig_notTT$f, col = "blue")

# Examine residuals
plot(fit.b.sig_notTT$resid)

# ASE with Burg estimates
ASE.b.full = mean((log.mhp[169:198] - fit.b.sig_notTT$f)^2)
ASE.b.exp.full = mean((exp(log.mhp[169:198]) - exp(fit.b.sig_notTT$f))^2)
ASE.b.exp.full # 658M

# Burg estimates worse than ASE as expected
ASEexp.full < ASE.b.exp.full

```

### Signal Plus Noise using 1 Yr Horizon
```{r Signal Plus Noise with 1 yr Horizon}
# Making sure log.mhp is the correct data
log.mhp = fed_housing_data$Median_Sales_Price

# Fit with MLE estimates, using all data
fit.mle.sig_h4 = fore.sigplusnoise.wge(log.mhp, linear = TRUE, method = 'mle', freq = 0, max.p = 6, n.ahead = 4, lastn = TRUE)
fit.mle.sig_h4$b0hat
fit.mle.sig_h4$b1hat

# Different Plot
plot(log.mhp, type = 'l')
lines(seq(195,198,1), fit.mle.sig_h4$f, col = "blue")

# Examine residuals
plot(fit.mle.sig_h4$resid)

# ASE with MLE estimates
ASE.h4 = mean((log.mhp[195:198] - fit.mle.sig_h4$f)^2)
ASEexp.h4 = mean((exp(log.mhp[195:198]) - exp(fit.mle.sig_h4$f))^2)
ASEexp.h4 # 50.92M

# Fit with burg estimates, using all data
fit.b.sig_h4 = fore.sigplusnoise.wge(log.mhp, linear = TRUE, method = 'burg', freq = 0, max.p = 6, n.ahead = 4, lastn = TRUE)
fit.b.sig_h4$b0hat
fit.b.sig_h4$b1hat

# Different Plot
plot(log.mhp, type = 'l')
lines(seq(195,198,1), fit.b.sig_h4$f, col = "blue")

# Examine residuals
plot(fit.b.sig_h4$resid)

# ASE with Burg estimates
ASE.b.h4 = mean((log.mhp[195:198] - fit.b.sig_h4$f)^2)
ASE.b.exp.h4 = mean((exp(log.mhp[195:198]) - exp(fit.b.sig_h4$f))^2)
ASE.b.exp.h4 # 54.75M

# Burg estimates worse than ASE as expected
ASEexp.h4 < ASE.b.exp.h4

```
### Signal Plus Noise using 3 Yr Horizon
```{r Signal Plus Noise with 3 yr horizon}
# Making sure log.mhp is the correct data
log.mhp = fed_housing_data$Median_Sales_Price

# Fit with MLE estimates, using all data
fit.mle.sig_h12 = fore.sigplusnoise.wge(log.mhp, linear = TRUE, method = 'mle', freq = 0, max.p = 6, n.ahead = 12, lastn = TRUE)
fit.mle.sig_h12$b0hat
fit.mle.sig_h12$b1hat

# Different Plot
plot(log.mhp, type = 'l')
lines(seq(187,198,1), fit.mle.sig_h12$f, col = "blue")

# Examine residuals
plot(fit.mle.sig_h12$resid)

# ASE with MLE estimates
ASE.h12 = mean((log.mhp[187:198] - fit.mle.sig_h12$f)^2)
ASEexp.h12 = mean((exp(log.mhp[187:198]) - exp(fit.mle.sig_h12$f))^2)
ASEexp.h12 # 620.35M

# Fit with burg estimates, using all data
fit.b.sig_h12 = fore.sigplusnoise.wge(log.mhp, linear = TRUE, method = 'burg', freq = 0, max.p = 6, n.ahead = 12, lastn = TRUE)
fit.b.sig_h12$b0hat
fit.b.sig_h12$b1hat

# Different Plot
plot(log.mhp, type = 'l')
lines(seq(187,198,1), fit.b.sig_h12$f, col = "blue")

# Examine residuals
plot(fit.b.sig_h12$resid)

# ASE with Burg estimates
ASE.b.h12 = mean((log.mhp[187:198] - fit.b.sig_h12$f)^2)
ASE.b.exp.h12 = mean((exp(log.mhp[187:198]) - exp(fit.b.sig_h12$f))^2)
ASE.b.exp.h12 # 621.99M

# Burg estimates worse ASE though
ASEexp.h12 < ASE.b.exp.h12
```
### Signal Plus Noise using 5 Yr Horizon
```{r Signal plus noise with 5 yr horizon}
# Making sure log.mhp is the correct data
log.mhp = fed_housing_data$Median_Sales_Price

# Fit with MLE estimates, using all data
fit.mle.sig_h20 = fore.sigplusnoise.wge(log.mhp, linear = TRUE, method = 'mle', freq = 0, max.p = 6, n.ahead = 20, lastn = TRUE)
fit.mle.sig_h20$b0hat
fit.mle.sig_h20$b1hat

# Different Plot
plot(log.mhp, type = 'l')
lines(seq(179,198,1), fit.mle.sig_h20$f, col = "blue")

# Examine residuals
plot(fit.mle.sig_h20$resid)

# ASE with MLE estimates
ASE.h20 = mean((log.mhp[179:198] - fit.mle.sig_h20$f)^2)
ASEexp.h20 = mean((exp(log.mhp[179:198]) - exp(fit.mle.sig_h20$f))^2)
ASEexp.h20 # 50.92M

# Fit with burg estimates, using all data
fit.b.sig_h20 = fore.sigplusnoise.wge(log.mhp, linear = TRUE, method = 'burg', freq = 0, max.p = 6, n.ahead = 20, lastn = TRUE)
fit.b.sig_h20$b0hat
fit.b.sig_h20$b1hat

# Different Plot
plot(log.mhp, type = 'l')
lines(seq(179,198,1), fit.b.sig_h20$f, col = "blue")

# Examine residuals
plot(fit.b.sig_h20$resid)

# ASE with Burg estimates
ASE.b.h20 = mean((log.mhp[179:198] - fit.mle.sig_h20$f)^2)
ASE.b.exp.h20 = mean((exp(log.mhp[179:198]) - exp(fit.mle.sig_h20$f))^2)
ASE.b.exp.h20 # 54.75M

# Burg estimates worse ASE though
ASEexp.h20 < ASE.b.exp.h20
```

```{r Rolling Window RMSE, error = F}
# Aaron's Rolling Window RMSE Code

# If you wanted to use all the fore.sigplusnoise.wge parameters, it would look something like this:
series = log.mhp
horizon = 12
linear = TRUE
method = "mle"
freq=0
max.p=5

# Rolling Window for 1 Year Horizon with MLE
horizon = 4
method = "mle"
source("functions_Aaron.R")
mle.p0h4 = roll.win.rmse.linplusnoise.ada(series, horizon, max.p = 0) # 0.03564353
mle.p1h4 = roll.win.rmse.linplusnoise.ada(series, horizon, max.p=1) # 0.03564353
mle.p2h4 = roll.win.rmse.linplusnoise.ada(series, horizon, max.p=2) # 0.03547613
mle.p3h4 = roll.win.rmse.linplusnoise.ada(series, horizon, max.p=3) # 0.03495764
mle.p4h4 = roll.win.rmse.linplusnoise.ada(series, horizon, max.p=4) # 0.03326752
mle.p5h4 = roll.win.rmse.linplusnoise.ada(series, horizon, max.p=5) # 0.03261551
mle.p6h4 = roll.win.rmse.linplusnoise.ada(series, horizon, max.p=6) # 0.03259507
mle.p7h4 = roll.win.rmse.linplusnoise.ada(series, horizon, max.p=7) # 0.03259507
mle.p8h4 = roll.win.rmse.linplusnoise.ada(series, horizon, max.p=8) # 0.03259507
mle.p16h4 = roll.win.rmse.linplusnoise.ada(series, horizon, max.p=16) # 0.03259507

# Rolling Window for 3 Year Horizon  with MLE
horizon = 12
source("functions_Aaron.R")
mle.p0h12 = roll.win.rmse.linplusnoise.ada(series, horizon, max.p = 0) # 0.0633149
mle.p1h12 = roll.win.rmse.linplusnoise.ada(series, horizon, max.p=1) # 0.06684004
mle.p2h12 = roll.win.rmse.linplusnoise.ada(series, horizon, max.p=2) # 0.06736302
mle.p3h12 = roll.win.rmse.linplusnoise.ada(series, horizon, max.p=3) # 0.06736302
mle.p4h12 = roll.win.rmse.linplusnoise.ada(series, horizon, max.p=4) # 0.0660697
mle.p5h12 = roll.win.rmse.linplusnoise.ada(series, horizon, max.p=5) # 0.06524557
mle.p6h12 = roll.win.rmse.linplusnoise.ada(series, horizon, max.p=6) # 0.06514193
mle.p7h12 = roll.win.rmse.linplusnoise.ada(series, horizon, max.p=7) # 0.06514193
mle.p8h12 = roll.win.rmse.linplusnoise.ada(series, horizon, max.p=8) # 0.06514193
mle.p16h12 = roll.win.rmse.linplusnoise.ada(series, horizon, max.p=16) # 0.06514193

# Rolling Window for 5 Year Horizon  with MLE
horizon = 20
source("functions_Aaron.R")
mle.p0h20 = roll.win.rmse.linplusnoise.ada(series, horizon, max.p = 0) # 0.08107048
mle.p1h20 = roll.win.rmse.linplusnoise.ada(series, horizon, max.p=1) # 0.08107048
mle.p2h20 = roll.win.rmse.linplusnoise.ada(series, horizon, max.p=2) # 0.08065467
mle.p3h20 = roll.win.rmse.linplusnoise.ada(series, horizon, max.p=3) # 0.07973718
mle.p4h20 = roll.win.rmse.linplusnoise.ada(series, horizon, max.p=4) # 0.07797091
mle.p5h20 = roll.win.rmse.linplusnoise.ada(series, horizon, max.p=5) # 0.07669397
mle.p6h20 = roll.win.rmse.linplusnoise.ada(series, horizon, max.p=6) # 0.0759512
mle.p7h20 = roll.win.rmse.linplusnoise.ada(series, horizon, max.p=7) # 0.0759512
mle.p8h20 = roll.win.rmse.linplusnoise.ada(series, horizon, max.p=8) # 0.0759512
mle.p16h20 = roll.win.rmse.linplusnoise.ada(series, horizon, max.p=16) # 0.0759512

# Rolling Window for 1 Year Horizon with Burg Estimates
horizon = 4
method = "burg"
source("functions_Aaron.R")
burg.p0h4 = roll.win.rmse.linplusnoise.ada(series, horizon, method = 'burg', max.p = 0) # 0.03564353
burg.p1h4 = roll.win.rmse.linplusnoise.ada(series, horizon, method = 'burg', max.p=1) # 0.03564353
burg.p2h4 = roll.win.rmse.linplusnoise.ada(series, horizon, method = 'burg', max.p=2) # 0.03549899
burg.p3h4 = roll.win.rmse.linplusnoise.ada(series, horizon, method = 'burg', max.p=3) # 0.03502246
burg.p4h4 = roll.win.rmse.linplusnoise.ada(series, horizon, method = 'burg', max.p=4) # 0.03336010
burg.p5h4 = roll.win.rmse.linplusnoise.ada(series, horizon, method = 'burg', max.p=5) # 0.03267275
burg.p6h4 = roll.win.rmse.linplusnoise.ada(series, horizon, method = 'burg', max.p=6) # 0.03260961
burg.p7h4 = roll.win.rmse.linplusnoise.ada(series, horizon, method = 'burg', max.p=7) # 0.03260961
burg.p8h4 = roll.win.rmse.linplusnoise.ada(series, horizon, method = 'burg', max.p=8) # 0.03260961
burg.p16h4 = roll.win.rmse.linplusnoise.ada(series, horizon, method = 'burg', max.p=16) # 0.03260961

# Rolling Window for 3 Year Horizon  with Burg Estimates
horizon = 12
source("functions_Aaron.R")
burg.p0h12 = roll.win.rmse.linplusnoise.ada(series, horizon, method = 'burg', max.p = 0) # 0.06331490
burg.p1h12 = roll.win.rmse.linplusnoise.ada(series, horizon, method = 'burg', max.p=1) # 0.06331494
burg.p2h12 = roll.win.rmse.linplusnoise.ada(series, horizon, method = 'burg', max.p=2) # 0.06341080
burg.p3h12 = roll.win.rmse.linplusnoise.ada(series, horizon, method = 'burg', max.p=3) # 0.06288096
burg.p4h12 = roll.win.rmse.linplusnoise.ada(series, horizon, method = 'burg', max.p=4) # 0.06106699
burg.p5h12 = roll.win.rmse.linplusnoise.ada(series, horizon, method = 'burg', max.p=5) # 0.05972861
burg.p6h12 = roll.win.rmse.linplusnoise.ada(series, horizon, method = 'burg', max.p=6) # 0.05904501
burg.p7h12 = roll.win.rmse.linplusnoise.ada(series, horizon, method = 'burg', max.p=7) # 0.05904501
burg.p8h12 = roll.win.rmse.linplusnoise.ada(series, horizon, method = 'burg', max.p=8) # 0.05904501
burg.p16h12 = roll.win.rmse.linplusnoise.ada(series, horizon, method = 'burg', max.p=16) # 0.05904501

# Rolling Window for 5 Year Horizon  with Burg Estimates
horizon = 20
source("functions_Aaron.R")
burg.p0h20 = roll.win.rmse.linplusnoise.ada(series, horizon, method = 'burg', max.p = 0) # 0.08107047
burg.p1h20 = roll.win.rmse.linplusnoise.ada(series, horizon, method = 'burg', max.p=1) # 0.08107047
burg.p2h20 = roll.win.rmse.linplusnoise.ada(series, horizon, method = 'burg', max.p=2) # 0.08072611
burg.p3h20 = roll.win.rmse.linplusnoise.ada(series, horizon, method = 'burg', max.p=3) # 0.07997433
burg.p4h20 = roll.win.rmse.linplusnoise.ada(series, horizon, method = 'burg', max.p=4) # 0.07842355
burg.p5h20 = roll.win.rmse.linplusnoise.ada(series, horizon, method = 'burg', max.p=5) # 0.07723106
burg.p6h20 = roll.win.rmse.linplusnoise.ada(series, horizon, method = 'burg', max.p=6) # 0.07642582
burg.p7h20 = roll.win.rmse.linplusnoise.ada(series, horizon, method = 'burg', max.p=7) # 0.07642582
burg.p8h20 = roll.win.rmse.linplusnoise.ada(series, horizon, method = 'burg', max.p=8) # 0.07642582
burg.p16h20 = roll.win.rmse.linplusnoise.ada(series, horizon, method = 'burg', max.p=16) # 0.07642582

# Testing if MLE or Burg has lower RSME at p = 6 (the best p for all horizons)
mle.p6h4 < burg.p6h4
mle.p6h12 < burg.p6h12
mle.p6h20 < burg.p6h20
```
## Evaluating Models
```{r}
# Look at White Noise
plotts.sample.wge(fit.mle.sig_notTT$resid, lag.max = 48, arlimits = TRUE)
ljung.wge(fit.mle.sig_notTT$resid, p = 6, q = 0, K = 48)

spn.mle.ar6.1 = gen.sigplusnoise.wge(n=198, b0 = fit.mle.sig_notTT$b0hat, 
                                   b1 = fit.mle.sig_notTT$b1hat,
                                   phi=fit.mle.sig_notTT$phi.z, 
                                   vara = fit.mle.sig_notTT$wnv, plot = F)
spn.mle.ar6.2 = gen.sigplusnoise.wge(n=198, b0 = fit.mle.sig_notTT$b0hat, 
                                   b1 = fit.mle.sig_notTT$b1hat,
                                   phi=fit.mle.sig_notTT$phi.z, 
                                   vara = fit.mle.sig_notTT$wnv, plot = F)
spn.mle.ar6.3 = gen.sigplusnoise.wge(n=198, b0 = fit.mle.sig_notTT$b0hat, 
                                   b1 = fit.mle.sig_notTT$b1hat,
                                   phi=fit.mle.sig_notTT$phi.z, 
                                   vara = fit.mle.sig_notTT$wnv, plot = F)
spn.mle.ar6.4 = gen.sigplusnoise.wge(n=198, b0 = fit.mle.sig_notTT$b0hat, 
                                   b1 = fit.mle.sig_notTT$b1hat,
                                   phi=fit.mle.sig_notTT$phi.z, 
                                   vara = fit.mle.sig_notTT$wnv, plot = F)
spn.mle.ar6.5 = gen.sigplusnoise.wge(n=198, b0 = fit.mle.sig_notTT$b0hat, 
                                   b1 = fit.mle.sig_notTT$b1hat,
                                   phi=fit.mle.sig_notTT$phi.z, 
                                   vara = fit.mle.sig_notTT$wnv, plot = F)
spn.mle.ar6.6 = gen.sigplusnoise.wge(n=198, b0 = fit.mle.sig_notTT$b0hat, 
                                   b1 = fit.mle.sig_notTT$b1hat,
                                   phi=fit.mle.sig_notTT$phi.z, 
                                   vara = fit.mle.sig_notTT$wnv, plot = F)
spn.mle.ar6.7 = gen.sigplusnoise.wge(n=198, b0 = fit.mle.sig_notTT$b0hat, 
                                   b1 = fit.mle.sig_notTT$b1hat,
                                   phi=fit.mle.sig_notTT$phi.z, 
                                   vara = fit.mle.sig_notTT$wnv, plot = F)
spn.mle.ar6.8 = gen.sigplusnoise.wge(n=198, b0 = fit.mle.sig_notTT$b0hat, 
                                   b1 = fit.mle.sig_notTT$b1hat,
                                   phi=fit.mle.sig_notTT$phi.z, 
                                   vara = fit.mle.sig_notTT$wnv, plot = F)
spn.mle.ar6.9 = gen.sigplusnoise.wge(n=198, b0 = fit.mle.sig_notTT$b0hat, 
                                   b1 = fit.mle.sig_notTT$b1hat,
                                   phi=fit.mle.sig_notTT$phi.z, 
                                   vara = fit.mle.sig_notTT$wnv, plot = F)
spn.mle.ar6.10 = gen.sigplusnoise.wge(n=198, b0 = fit.mle.sig_notTT$b0hat, 
                                   b1 = fit.mle.sig_notTT$b1hat,
                                   phi=fit.mle.sig_notTT$phi.z, 
                                   vara = fit.mle.sig_notTT$wnv, plot = F)

ten.generated = list(spn.mle.ar6.1, spn.mle.ar6.2, spn.mle.ar6.3, spn.mle.ar6.4, spn.mle.ar6.5, spn.mle.ar6.6, spn.mle.ar6.7, spn.mle.ar6.8, spn.mle.ar6.9, spn.mle.ar6.10)

# ten.generated[[1]]
# parzen.wge(ten.generated[[1]])

# Compare Spectral Densities
sims = 10
SpecDen = parzen.wge(log.mhp, plot = FALSE)
plot(SpecDen$freq,SpecDen$pzgram, type = "l", lwd = 3)

for( i in 1: sims)
{
   SpecDen2 = parzen.wge(ten.generated[[i]], plot = FALSE)
   lines(SpecDen2$freq,SpecDen2$pzgram, lwd = 2, col = "red")
}

#Compare ACFs
sims = 10
ACF = acf(log.mhp, plot = "FALSE")
plot(ACF$lag ,ACF$acf , type = "l", lwd = 4)

for( i in 1: sims)
{
   ACF2 = acf(ten.generated[[i]], plot = "FALSE")
   lines(ACF2$lag ,ACF2$acf, lwd = 1, col = "red")
}
```

## Model Choice

While the burg estimates had a lower AIC than the MLE estimates, the MLE method of forecasting had better ASE and better rolling window RMSE for all three forecasts (1 yr, 3 yr, and 5 yr)

Our final Signal Plus Noise Model is Xt = 10.871 + .011t + zt, where (1 - .716B - .367B2 - 0.137B3 + 0.062B4 + .076B5 + .118B5)Zt with sigma2 = 0.0006929526

Wording: 

In 1 year, we are 95% confident that the median home sale price will be between $387,759 (e^12.86814) and $468,321 (e^13.05691). Our best estimate is $426,142 (e^12.96253).

In 5 years, we are 95% confident that the median home sale price will be between $419,048 (e^12.94574) and $669,482 (e^13.41426). Our best estimate is $529,665 (e^13.18).

```{r}

# Fit with MLE estimates, using all data, forecasting ahead 1 year
fit.mle.sig_h4_ahead = fore.sigplusnoise.wge(log.mhp, linear = TRUE, method = 'mle', freq = 0, max.p = 6, n.ahead = 4, lastn = FALSE)

# Fit with MLE estimates, using all data, forecasting ahead 5 years
fit.mle.sig_h20_ahead = fore.sigplusnoise.wge(log.mhp, linear = TRUE, method = 'mle', freq = 0, max.p = 6, n.ahead = 20, lastn = FALSE)

# Checking if models all have same intercept, slope, and phis
fit.mle.sig_notTT$b0hat == fit.mle.sig_h4_ahead$b0hat
fit.mle.sig_notTT$b1hat == fit.mle.sig_h4_ahead$b1hat
fit.mle.sig_notTT$phi.z == fit.mle.sig_h4_ahead$phi.z

# Model Coefficients
fit.mle.sig_notTT$phi.z
fit.mle.sig_notTT$b0hat
fit.mle.sig_notTT$b1hat
fit.mle.sig_notTT$wnv

# Confidence Intervals

# 1 Year
fit.mle.sig_h4_ahead$ll[4]
fit.mle.sig_h4_ahead$ul[4]
fit.mle.sig_h4_ahead$f[4]

# 5 Years
fit.mle.sig_h20_ahead$ll[20]
fit.mle.sig_h20_ahead$ul[20]
fit.mle.sig_h20_ahead$f[20]
```

## Neural Net (MLP)

MLP
```{r MLP Univariate}
# Univariate

msp.194 = ts(log.mhp[1:194])
msp.186 = ts(log.mhp[1:186])
msp.178 = ts(log.mhp[1:178])

# 1 Year Horizon
mspFit.4 = mlp(msp.194)
f.4 = forecast(mspFit.4, h = 4)
plot(log.mhp[195:198], type = 'l', ylim = c(12.9, 13))
lines(seq(1,4), f.4$mean, col = "blue")
ASE.mlp.exp.h4 = mean((exp(log.mhp[195:198]) - exp(f.4$mean))^2)
ASE.mlp.exp.h4 # 91.51M
rwfit.mlp4 = roll.win.rmse.nn.wge(log.mhp, horizon = 4, fit_model = mspFit.4)

# 3 Year Horizon
mspFit.12 = mlp(msp.186)
f.12 = forecast(mspFit.12, h = 12)
plot(log.mhp[187:198], type = 'l', ylim = c(12.75, 13))
lines(seq(1,12), f.12$mean, col = "blue")
ASE.mlp.exp.h12 = mean((exp(log.mhp[187:198]) - exp(f.12$mean))^2)
ASE.mlp.exp.h12 # 949.55N
rwfit.mlp12 = roll.win.rmse.nn.wge(log.mhp, horizon = 12, fit_model = mspFit.12)

# 5 Year Horizon
mspFit.20 = mlp(msp.178)
f.20 = forecast(mspFit.20, h = 20)
plot(log.mhp[179:198], type = 'l', ylim = c(12.5, 13))
lines(seq(1,20), f.20$mean, col = "blue")
ASE.mlp.exp.h20 = mean((exp(log.mhp[195:198]) - exp(f.20$mean))^2)
ASE.mlp.exp.h20 # 5.43B
rwfit.mlp20 = roll.win.rmse.nn.wge(log.mhp, horizon = 20, fit_model = mspFit.20)

plot(log.mhp, type = 'l')
points(seq(195,198), f.4$mean, type = 'l', col = 'red', pch = 3)
points(seq(187,198), f.12$mean, type = 'l', col = 'darkorange', pch = 3)
points(seq(179,198), f.20$mean, type = 'l', col = 'green', pch = 3)
```

```{r MLP Multivariate Baseline}
# Multivariate

# Establishing Baseline

# Response Variable
mhp.train.4 = ts(fed_housing_data$Median_Sales_Price[1:194])
mhp.train.12 = ts(fed_housing_data$Median_Sales_Price[1:186])
mhp.train.20 = ts(fed_housing_data$Median_Sales_Price[1:178])

mhp.test.4 = fed_housing_data$Median_Sales_Price[195:198]
mhp.test.12 = fed_housing_data$Median_Sales_Price[187:198]
mhp.test.20 = fed_housing_data$Median_Sales_Price[179:198]

# Exogenous Variables
hor.194 = fed_housing_data$Ownership_Rate[1:194]
hor.186 = fed_housing_data$Ownership_Rate[1:186]
hor.178 = fed_housing_data$Ownership_Rate[1:178]

huc.194 = fed_housing_data$Housing_Units_Completed[1:194]
huc.186 = fed_housing_data$Housing_Units_Completed[1:186]
huc.178 = fed_housing_data$Housing_Units_Completed[1:178]

snh.194 = fed_housing_data$Supply_New_Houses[1:194]
snh.186 = fed_housing_data$Supply_New_Houses[1:186]
snh.178 = fed_housing_data$Supply_New_Houses[1:178]

hpi.194 = fed_housing_data$Housing_Price_Index[1:194]
hpi.186 = fed_housing_data$Housing_Price_Index[1:186]
hpi.178 = fed_housing_data$Housing_Price_Index[1:178]

# Exogenous Variable Training Dataframe for xreg
ts.train.X.4 = data.frame(hor = ts(hor.194), huc = ts(huc.194), snh = ts(snh.194), hpi = ts(hpi.194))
ts.train.X.12 = data.frame(hor = ts(hor.186), huc = ts(huc.186), snh = ts(snh.186), hpi = ts(hpi.186))
ts.train.X.20 = data.frame(hor = ts(hor.178), huc = ts(huc.178), snh = ts(snh.178), hpi = ts(hpi.178))

# Baseline Fits for 1 yr, 3 yr, and 5 yr
fit.mlp.4 = mlp(mhp.train.4, reps = 30, comb = 'median', xreg = ts.train.X.4, difforder = 0, sel.lag = TRUE)
fit.mlp.4

fit.mlp.12 = mlp(mhp.train.12, reps = 30, comb = 'median', xreg = ts.train.X.12, difforder = 0, sel.lag = TRUE)
fit.mlp.12

fit.mlp.20 = mlp(mhp.train.20, reps = 30, comb = 'median', xreg = ts.train.X.20, difforder = 0, sel.lag = TRUE)
fit.mlp.20

# Baseline forecasts for 1 yr
fit.mlp.hor.4 = mlp(ts(ts.train.X.4$hor), reps = 30, comb = 'median')
fore.mlp.hor.4 = forecast(fit.mlp.hor.4, h = 4)
fore.mlp.hor.4

fit.mlp.huc.4 = mlp(ts(ts.train.X.4$huc), reps = 30, comb = 'median')
fore.mlp.huc.4 = forecast(fit.mlp.huc.4, h = 4)
fore.mlp.huc.4

fit.mlp.snh.4 = mlp(ts(ts.train.X.4$snh), reps = 30, comb = 'median')
fore.mlp.snh.4 = forecast(fit.mlp.snh.4, h = 4)
fore.mlp.snh.4

fit.mlp.hpi.4 = mlp(ts(ts.train.X.4$hpi), reps = 30, comb = 'median')
fore.mlp.hpi.4 = forecast(fit.mlp.hpi.4, h = 4)
fore.mlp.hpi.4

# Baseline forecasts for 3 yr
fit.mlp.hor.12 = mlp(ts(ts.train.X.12$hor), reps = 30, comb = 'median')
fore.mlp.hor.12 = forecast(fit.mlp.hor.12, h = 12)
fore.mlp.hor.12

fit.mlp.huc.12 = mlp(ts(ts.train.X.12$huc), reps = 30, comb = 'median')
fore.mlp.huc.12 = forecast(fit.mlp.huc.12, h = 12)
fore.mlp.huc.12

fit.mlp.snh.12 = mlp(ts(ts.train.X.12$snh), reps = 30, comb = 'median')
fore.mlp.snh.12 = forecast(fit.mlp.snh.12, h = 12)
fore.mlp.snh.12

fit.mlp.hpi.12 = mlp(ts(ts.train.X.12$hpi), reps = 30, comb = 'median')
fore.mlp.hpi.12 = forecast(fit.mlp.hpi.12, h = 12)
fore.mlp.hpi.12

# Baseline forecasts for 5 yr
fit.mlp.hor.20 = mlp(ts(ts.train.X.20$hor), reps = 30, comb = 'median')
fore.mlp.hor.20 = forecast(fit.mlp.hor.20, h = 20)
fore.mlp.hor.20

fit.mlp.huc.20 = mlp(ts(ts.train.X.20$huc), reps = 30, comb = 'median')
fore.mlp.huc.20 = forecast(fit.mlp.huc.20, h = 20)
fore.mlp.huc.20

fit.mlp.snh.20 = mlp(ts(ts.train.X.20$snh), reps = 30, comb = 'median')
fore.mlp.snh.20 = forecast(fit.mlp.snh.20, h = 20)
fore.mlp.snh.20

fit.mlp.hpi.20 = mlp(ts(ts.train.X.20$hpi), reps = 30, comb = 'median')
fore.mlp.hpi.20 = forecast(fit.mlp.hpi.20, h = 20)
fore.mlp.hpi.20

# Exogenous Variable Testing Dataframe for xreg
ts.test.X.4 = data.frame(hor = ts(fore.mlp.hor.4$mean), huc = ts(fore.mlp.huc.4$mean), 
                         snh = ts(fore.mlp.snh.4$mean), hpi = ts(fore.mlp.hpi.4$mean))

ts.test.X.12 = data.frame(hor = ts(fore.mlp.hor.12$mean), huc = ts(fore.mlp.huc.12$mean), 
                          snh = ts(fore.mlp.snh.12$mean), hpi = ts(fore.mlp.hpi.12$mean))

ts.test.X.20 = data.frame(hor = ts(fore.mlp.hor.20$mean), huc = ts(fore.mlp.huc.20$mean), 
                          snh = ts(fore.mlp.snh.20$mean), hpi = ts(fore.mlp.hpi.20$mean))

# Known and Forecasted Dataframe for xreg
ts.forecasted.X.4 = data.frame(hor = ts(c(hor.194, fore.mlp.hor.4$mean)), huc = ts(c(huc.194, fore.mlp.huc.4$mean)), 
                         snh = ts(c(snh.194, fore.mlp.snh.4$mean)), hpi = ts(c(hpi.194, fore.mlp.hpi.4$mean)))

ts.forecasted.X.12 = data.frame(hor = ts(c(hor.186, fore.mlp.hor.12$mean)), huc = ts(c(huc.186, fore.mlp.huc.12$mean)), 
                         snh = ts(c(snh.186, fore.mlp.snh.12$mean)), hpi = ts(c(hpi.186, fore.mlp.hpi.12$mean)))

ts.forecasted.X.20 = data.frame(hor = ts(c(hor.178, fore.mlp.hor.20$mean)), huc = ts(c(huc.178, fore.mlp.huc.20$mean)), 
                         snh = ts(c(snh.178, fore.mlp.snh.20$mean)), hpi = ts(c(hpi.178, fore.mlp.hpi.20$mean)))

# Forecasting the last 1 yr, 3 yr, 5 yrs
forecasted.mlp.X.4 = forecast(fit.mlp.4, h = 4, xreg = ts.forecasted.X.4)
forecasted.mlp.X.4

forecasted.mlp.X.12 = forecast(fit.mlp.12, h = 12, xreg = ts.forecasted.X.12)
forecasted.mlp.X.12

forecasted.mlp.X.20 = forecast(fit.mlp.20, h = 20, xreg = ts.forecasted.X.20)
forecasted.mlp.X.20

# Competing Model 1
fit.mlp.d1.4 = mlp(mhp.train.4, reps = 30, comb = 'median', xreg = ts.train.X.4, difforder = 1, sel.lag = TRUE)
fit.mlp.d1.4

fit.mlp.d1.12 = mlp(mhp.train.12, reps = 30, comb = 'median', xreg = ts.train.X.12, difforder = 1, sel.lag = TRUE)
fit.mlp.d1.12

fit.mlp.d1.20 = mlp(mhp.train.20, reps = 30, comb = 'median', xreg = ts.train.X.20, difforder = 1, sel.lag = TRUE)
fit.mlp.d1.20

# Forecasting the last 1 yr, 3 yr, 5 yrs
forecasted.mlp.X.d1.4 = forecast(fit.mlp.d1.4, h = 4, xreg = ts.forecasted.X.4)
forecasted.mlp.X.d1.4

forecasted.mlp.X.d1.12 = forecast(fit.mlp.d1.12, h = 12, xreg = ts.forecasted.X.12)
forecasted.mlp.X.d1.12

forecasted.mlp.X.d1.20 = forecast(fit.mlp.d1.20, h = 20, xreg = ts.forecasted.X.20)
forecasted.mlp.X.d1.20

# Competing Model 2
fit.mlp.d2.4 = mlp(mhp.train.4, reps = 30, comb = 'median', xreg = ts.train.X.4, difforder = 2, sel.lag = TRUE)
fit.mlp.d2.4

fit.mlp.d2.12 = mlp(mhp.train.12, reps = 30, comb = 'median', xreg = ts.train.X.12, difforder = 2, sel.lag = TRUE)
fit.mlp.d2.12

fit.mlp.d2.20 = mlp(mhp.train.20, reps = 30, comb = 'median', xreg = ts.train.X.20, difforder = 2, sel.lag = TRUE)
fit.mlp.d2.20

# Forecasting the last 1 yr, 3 yr, 5 yrs
forecasted.mlp.X.d2.4 = forecast(fit.mlp.d2.4, h = 4, xreg = ts.forecasted.X.4)
forecasted.mlp.X.d2.4

forecasted.mlp.X.d2.12 = forecast(fit.mlp.d2.12, h = 12, xreg = ts.forecasted.X.12)
forecasted.mlp.X.d2.12

forecasted.mlp.X.d2.20 = forecast(fit.mlp.d2.20, h = 20, xreg = ts.forecasted.X.20)
forecasted.mlp.X.d2.20

# Competing Model 3
fit.mlp.dx.4 = mlp(mhp.train.4, reps = 30, comb = 'median', xreg = ts.train.X.4, sel.lag = TRUE)
fit.mlp.dx.4

fit.mlp.dx.12 = mlp(mhp.train.12, reps = 30, comb = 'median', xreg = ts.train.X.12, sel.lag = TRUE)
fit.mlp.dx.12

fit.mlp.dx.20 = mlp(mhp.train.20, reps = 30, comb = 'median', xreg = ts.train.X.20, sel.lag = TRUE)
fit.mlp.dx.20

# Forecasting the last 1 yr, 3 yr, 5 yrs
forecasted.mlp.X.dx.4 = forecast(fit.mlp.dx.4, h = 4, xreg = ts.forecasted.X.4)
forecasted.mlp.X.dx.4

forecasted.mlp.X.dx.12 = forecast(fit.mlp.dx.12, h = 12, xreg = ts.forecasted.X.12)
forecasted.mlp.X.dx.12

forecasted.mlp.X.dx.20 = forecast(fit.mlp.dx.20, h = 20, xreg = ts.forecasted.X.20)
forecasted.mlp.X.dx.20
```
Assessing the Models

```{r Assessing mlp models}
# 1 Year Models
plot(log.mhp[195:198], type = 'l', ylim = c(12.75, 13.2))
lines(seq(1,4), forecasted.mlp.X.4$mean, col = "blue")
lines(seq(1,4), forecasted.mlp.X.d1.4$mean, col = "red")
lines(seq(1,4), forecasted.mlp.X.d2.4$mean, col = "orange")
lines(seq(1,4), forecasted.mlp.X.dx.4$mean, col = "green")

# Baseline Model
ASE.mlp.exp.x.h4 = mean((exp(log.mhp[195:198]) - exp(forecasted.mlp.X.4$mean))^2)
ASE.mlp.exp.x.h4 # 725N
RMSE.baseline.x.4 = sqrt(mean((mhp.test.4 - forecasted.mlp.X.4$mean)^2))
RMSE.baseline.x.4 # 0.0617

# Competing Model 1
ASE.mlp.exp.x.d1.h4 = mean((exp(log.mhp[195:198]) - exp(forecasted.mlp.X.d1.4$mean))^2)
ASE.mlp.exp.x.d1.h4 #524M
RMSE.x.d1.4 = sqrt(mean((mhp.test.4 - forecasted.mlp.X.d1.4$mean)^2))
RMSE.x.d1.4 # 0.0528

# Competing Model 2
ASE.mlp.exp.x.d2.h4 = mean((exp(log.mhp[195:198]) - exp(forecasted.mlp.X.d2.4$mean))^2)
ASE.mlp.exp.x.d2.h4 # 719M
RMSE.x.d2.4 = sqrt(mean((mhp.test.4 - forecasted.mlp.X.d2.4$mean)^2))
RMSE.x.d2.4 # 0.0616

# Competing Model 3
ASE.mlp.exp.x.dx.h4 = mean((exp(log.mhp[195:198]) - exp(forecasted.mlp.X.dx.4$mean))^2)
ASE.mlp.exp.x.dx.h4 # 254M
RMSE.x.dx.4 = sqrt(mean((mhp.test.4 - forecasted.mlp.X.dx.4$mean)^2))
RMSE.x.dx.4 # 0.037


# 3 Yr Models
plot(log.mhp[187:198], type = 'l', ylim = c(12.75, 13.5))
lines(seq(1,12), forecasted.mlp.X.12$mean, col = "blue")
lines(seq(1,12), forecasted.mlp.X.d1.12$mean, col = "red")
lines(seq(1,12), forecasted.mlp.X.d2.12$mean, col = "orange")
lines(seq(1,12), forecasted.mlp.X.dx.12$mean, col = "green")

# Baseline Model
ASE.mlp.exp.x.h12 = mean((exp(log.mhp[187:198]) - exp(forecasted.mlp.X.12$mean))^2)
ASE.mlp.exp.x.h12 # 4.4B
RMSE.baseline.x.12 = sqrt(mean((mhp.test.4 - forecasted.mlp.X.12$mean)^2))
RMSE.baseline.x.12 # 0.1706

# Competing Model 1
ASE.mlp.exp.x.d1.h12 = mean((exp(log.mhp[187:198]) - exp(forecasted.mlp.X.d1.12$mean))^2)
ASE.mlp.exp.x.d1.h12 # 8.02B
RMSE.x.d1.12 = sqrt(mean((mhp.test.12 - forecasted.mlp.X.d1.12$mean)^2))
RMSE.x.d1.12 # 0.1838

# Competing Model 2
ASE.mlp.exp.x.d2.h12 = mean((exp(log.mhp[187:198]) - exp(forecasted.mlp.X.d2.12$mean))^2)
ASE.mlp.exp.x.d2.h12 # 600M
RMSE.x.d2.12 = sqrt(mean((mhp.test.12 - forecasted.mlp.X.d2.12$mean)^2))
RMSE.x.d2.12 # 0.059

# Competing Model 3
ASE.mlp.exp.x.dx.h12 = mean((exp(log.mhp[187:198]) - exp(forecasted.mlp.X.dx.12$mean))^2)
ASE.mlp.exp.x.dx.h12 # 13.66B
RMSE.x.dx.12 = sqrt(mean((mhp.test.12 - forecasted.mlp.X.dx.12$mean)^2))
RMSE.x.dx.12 # 0.2305

# 5 Yr Models
plot(log.mhp[179:198], type = 'l', ylim = c(12.3, 13.1))
lines(seq(1,20), forecasted.mlp.X.20$mean, col = "blue")
lines(seq(1,20), forecasted.mlp.X.d1.20$mean, col = "red")
lines(seq(1,20), forecasted.mlp.X.d2.20$mean, col = "orange")
lines(seq(1,20), forecasted.mlp.X.dx.20$mean, col = "green")

# Baseline Model
ASE.mlp.exp.x.h20 = mean((exp(log.mhp[179:198]) - exp(forecasted.mlp.X.20$mean))^2)
ASE.mlp.exp.x.h20 #11.55B
RMSE.baseline.x.20 = sqrt(mean((mhp.test.20 - forecasted.mlp.X.20$mean)^2))
RMSE.baseline.x.20 # 0.3062

# Competing Model 1
ASE.mlp.exp.x.d1.h20 = mean((exp(log.mhp[179:198]) - exp(forecasted.mlp.X.d1.20$mean))^2)
ASE.mlp.exp.x.d1.h20 # 14.86B
RMSE.x.d1.20 = sqrt(mean((mhp.test.20 - forecasted.mlp.X.d1.20$mean)^2))
RMSE.x.d1.20 # 0.3593

# Competing Model 2
ASE.mlp.exp.x.d2.h20 = mean((exp(log.mhp[179:198]) - exp(forecasted.mlp.X.d2.20$mean))^2)
ASE.mlp.exp.x.d2.h20 # 8.437B
RMSE.x.d2.20 = sqrt(mean((mhp.test.20 - forecasted.mlp.X.d2.20$mean)^2))
RMSE.x.d2.20 # 0.253

# Competing Model 3
ASE.mlp.exp.x.dx.h20 = mean((exp(log.mhp[179:198]) - exp(forecasted.mlp.X.dx.20$mean))^2)
ASE.mlp.exp.x.dx.h20 # 12.8B
RMSE.x.dx.20 = sqrt(mean((mhp.test.20 - forecasted.mlp.X.dx.20$mean)^2))
RMSE.x.dx.20 # 0.327

# Best Models
plot(log.mhp, type = 'l')
points(seq(195,198), forecasted.mlp.X.dx.4$mean, type = 'l', col = 'green', pch = 3)
points(seq(187,198), forecasted.mlp.X.d2.12$mean, type = 'l', col = 'darkorange', pch = 3)
points(seq(179,198), forecasted.mlp.X.d2.20$mean, type = 'l', col = 'darkorange', pch = 3)

```

```{r Multivariate Forecasting}
# Refit the model using all the data
ts.X = data.frame(hor = ts(fed_housing_data$Ownership_Rate), huc = ts(fed_housing_data$Housing_Units_Completed), snh = ts(fed_housing_data$Supply_New_Houses), hpi = ts(fed_housing_data$Housing_Price_Index))

# Forecasting Exogenous Variables
fit.mlp.hor = mlp(ts(ts.X$hor), reps = 30, comb = 'median')
fore.mlp.hor.4 = forecast(fit.mlp.hor, h = 4)
fore.mlp.hor.4
fore.mlp.hor.20 = forecast(fit.mlp.hor, h = 20)
fore.mlp.hor.20

fit.mlp.huc = mlp(ts(ts.X$huc), reps = 30, comb = 'median')
fore.mlp.huc.4 = forecast(fit.mlp.huc, h = 4)
fore.mlp.huc.4
fore.mlp.huc.20 = forecast(fit.mlp.huc, h = 20)
fore.mlp.huc.20

fit.mlp.snh = mlp(ts(ts.X$snh), reps = 30, comb = 'median')
fore.mlp.snh.4 = forecast(fit.mlp.snh, h = 4)
fore.mlp.snh.4
fore.mlp.snh.20 = forecast(fit.mlp.snh, h = 20)
fore.mlp.snh.20

fit.mlp.hpi = mlp(ts(ts.X$hpi), reps = 30, comb = 'median')
fore.mlp.hpi.4 = forecast(fit.mlp.hpi, h = 4)
fore.mlp.hpi.4
fore.mlp.hpi.20 = forecast(fit.mlp.hpi, h = 20)
fore.mlp.hpi.20

# Known and Forecasted Dataframe for xreg
ts.all.X.4 = data.frame(hor = ts(c(ts.X$hor, fore.mlp.hor.4$mean)), huc = ts(c(ts.X$huc, fore.mlp.huc.4$mean)), 
                         snh = ts(c(ts.X$snh, fore.mlp.snh.4$mean)), hpi = ts(c(ts.X$hpi, fore.mlp.hpi.4$mean)))

ts.all.X.20 = data.frame(hor = ts(c(ts.X$hor, fore.mlp.hor.20$mean)), huc = ts(c(ts.X$hor, fore.mlp.huc.20$mean)), 
                         snh = ts(c(ts.X$hor, fore.mlp.snh.20$mean)), hpi = ts(c(ts.X$hor, fore.mlp.hpi.20$mean)))

# Default predictions, 1 Yr Horizon
mlpFit.xreg.4 = mlp(ts(log.mhp), comb = 'median', xreg = ts.X)
f.xreg.4 = forecast(mlpFit.xreg.4, h = 4, xreg = ts.all.X.4)

# Difforder = 2 predictions, 5 yr Horizon
mlpFit.xreg.d2.20 = mlp(ts(log.mhp), comb = 'median', difforder = 2, xreg = ts.X)
f.xreg.d2.20 = forecast(mlpFit.xreg.d2.20, h = 20, xreg = ts.all.X.20)

# Forecasting next year and 5 years
plot(log.mhp[1:198], type = 'l', xlim = c(1,218), ylim = c(10.5, 13.25))
lines(seq(199,202), f.xreg.4$mean, col = "green")
lines(seq(199,218), f.xreg.d2.20$mean, col = "darkorange")
```
## Evaluate the Model

```{r}

# Look at White Noise
resid.mlp.4 = log.mhp[195:198] - forecasted.mlp.X.dx.4$mean
plot(resid.mlp.4)
acf(resid.mlp.4)
hist(resid.mlp.4)
                            
resid.mlp.20 = log.mhp[179:198] - forecasted.mlp.X.d2.20$mean
plot(resid.mlp.20)
acf(resid.mlp.20)
hist(resid.mlp.20)
plotts.sample.wge(resid.mlp.20, arlimits = TRUE)

```
